<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="docker-image-for-grav-in-development"><a href="#index">Docker Image for Grav (in development)</a></h1>
<p>TL;DR [Updated: 07.12.2022]</p>
<img src="./media/Grav_logo.svg" alt="Grav CMS" title="Grav CMS" width="15%"/>
<p>[<a href="#img-grav" target="_blank">IMG.1</a>]: Grav CMS</p>
<h2 id="index">Index</h2>
<ul>
<li><a href="#docker-image-for-grav-in-development">Docker Image for Grav (in development)</a>
<ul>
<li><a href="#index">Index</a></li>
<li><a href="#10-prerequisites">1.0 Prerequisites</a>
<ul>
<li><a href="#11-packages">1.1 Packages</a></li>
</ul>
</li>
<li><a href="#20-project-structure">2.0 Project structure</a>
<ul>
<li><a href="#21-project-features">2.1 Project features</a></li>
<li><a href="#22-work-in-progress">2.2 Work in progress</a></li>
</ul>
</li>
<li><a href="#30-installation-procedure">3.0 Installation procedure</a>
<ul>
<li><a href="#31-installation-checklist">3.1 Installation checklist</a></li>
<li><a href="#32-using-local-keyvalue-files-for-configuration">3.2 Using local key/value files for configuration</a></li>
<li><a href="#33-using-docker-multiarch-environment">3.3 Using docker multiarch environment</a></li>
<li><a href="#34-using-local-docker-cache-repository">3.4 Using local docker cache repository</a></li>
<li><a href="#35-handling-user-password-and-ssh-secrets">3.5 Handling user password and SSH secrets</a></li>
<li><a href="#36-caching-docker-buildtime">3.6 Caching docker buildtime</a></li>
<li><a href="#37-running-services-as-non-root-user">3.7 Running services as non-root user</a></li>
<li><a href="#38-persisting-build-cache-using-ccache-and-rsync">3.8 Persisting build cache using ccache and rsync</a></li>
<li><a href="#39-working-with-vscode-locally-or-remotely">3.9 Working with vscode locally or remotely</a></li>
<li><a href="#310-managing-a-container-from-the-command-line">3.10 Managing a container from the command line</a></li>
</ul>
</li>
<li><a href="#40-configuring-a-container-from-the-command-line">4.0 Configuring a container from the command line</a>
<ul>
<li><a href="#41-downloading-files-to-be-cached-into-the-rootfs-directory">4.1 Downloading files to be cached into the rootfs directory</a></li>
<li><a href="#42-persisting-data-into-an-external-storage">4.2 Persisting data into an external storage</a></li>
<li><a href="#43-building-the-image-from-dockerfile">4.3 Building the image from Dockerfile</a></li>
</ul>
</li>
<li><a href="#50-running-the-image-from-dockerfile">5.0 Running the image from Dockerfile</a></li>
<li><a href="#60-abbreviation-reference-list">6.0 Abbreviation reference list</a></li>
<li><a href="#70-image-reference-list">7.0 Image reference list</a></li>
<li><a href="#80-link-reference-list">8.0 Link reference list</a></li>
</ul>
</li>
</ul>
<h2 id="10-prerequisites"><a href="#index">1.0 Prerequisites</a></h2>
<p>This project is cloned from the official <a href="https://github.com/getgrav/docker-grav">GRAV GitHub</a> repository. If you want work with me, feel free to download it from <a href="https://github.com/giminni/docker-grav">my GitHub</a> repository.</p>
<p>It contains the original packages based on PHP 8.1:</p>
<table>
<thead>
<tr>
<th style="text-align:left">ORIGINAL</th>
<th style="text-align:left">PACKAGES</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">docker-ce</td>
<td style="text-align:left">vim editor</td>
</tr>
<tr>
<td style="text-align:left">apache-2.4.38</td>
<td style="text-align:left">php8.1</td>
</tr>
<tr>
<td style="text-align:left">GD library</td>
<td style="text-align:left">php8.1-opcache</td>
</tr>
<tr>
<td style="text-align:left">Unzip library</td>
<td style="text-align:left">php8.1-acpu</td>
</tr>
<tr>
<td style="text-align:left">cron</td>
<td style="text-align:left">php8.1-yaml</td>
</tr>
</tbody>
</table>
<p>In addition other packages are included:</p>
<table>
<thead>
<tr>
<th style="text-align:left">REQUIRED</th>
<th style="text-align:left">PACKAGES</th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
<th style="text-align:left"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ca-certificates</td>
<td style="text-align:left">php8.1_pdo</td>
<td style="text-align:left">openssh-client</td>
<td style="text-align:left">yq (&gt;= 4.29)</td>
<td style="text-align:left">wget (&gt;= 1.20)</td>
</tr>
<tr>
<td style="text-align:left">ccache</td>
<td style="text-align:left">php8.1_pdo_mysql</td>
<td style="text-align:left">rsync</td>
<td style="text-align:left">uuid (&gt;= -v4)</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">iputils-ping</td>
<td style="text-align:left">php8.1_pdo_pqsql</td>
<td style="text-align:left">sudo</td>
<td style="text-align:left">openssl (&gt;= 1.1.1)</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">net-tools</td>
<td style="text-align:left">php8.1-pgsql</td>
<td style="text-align:left">tree (&gt;= 1.8.0)</td>
<td style="text-align:left">git (&gt;= 2.17)</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">dropbear</td>
<td style="text-align:left">php8.1_xdebug</td>
<td style="text-align:left">jq (&gt;= 1.5)</td>
<td style="text-align:left">getssl (&gt;= 2.32)</td>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<blockquote>
<p>NOTE: Please ensure that the PHP base docker image is an actual version (e.g. php8.1) and not <a href="#EOL">[EOL]</a>, otherwise application security is highly impacted.</p>
</blockquote>
<h3 id="11-packages"><a href="#index">1.1 Packages</a></h3>
<p>This project needs the following prerequisites on the HOST machine:</p>
<ul>
<li>Install at least uuid -v4 &gt;= 1.5
(macOS: brew install ossp-uuid)
(Ubuntu: sudo apt install uuid)
(Alpine: sudo apk add -U ossp-uuid)</li>
<li>Install at least jq &gt;= 1.5
(macOS: brew install jq)
(Ubuntu: sudo apt install jq)
(Alpine: sudo apk add -U jq)</li>
<li>Install at least yq &gt;= 4.29
(macOS: brew install yq)
(Ubuntu: sudo apt install yq)
(Alpine: sudo apk add -U yq)</li>
<li>Install at least openssl &gt;= 1.1.1
(macOS: brew install openssl@1.1)
(Ubuntu: sudo apt install openssl)
(Alpine: sudo apk add -U openssl)</li>
<li>Install at least docker-ce &gt;= 20.10
(Ubuntu: sudo apt install docker-ce)
(Alpine: sudo apk add -U docker)
(See <a href="https://docs.docker.com/engine/install">https://docs.docker.com/engine/install</a>)
or Docker Desktop for Mac which includes docker-ce<br>
(macOS: brew install --cask docker)</li>
<li>Install at least docker buildx plugin &gt;= 0.5.0
(See <a href="https://docs.docker.com/buildx/working-with-buildx">https://docs.docker.com/buildx/working-with-buildx</a>)
NOTE: It is already included in a recent version of docker.</li>
<li>Install at least getssl &gt;= 2.32
(See <a href="https://github.com/srvrco/getssl">https://github.com/srvrco/getssl</a>)
(macOS: <code>curl --silent https://raw.githubusercontent.com/srvrco/getssl/master/getssl &gt; getssl &amp;&amp; chmod 700 getssl &amp;&amp; sudo mv getssl /usr/local/bin</code>)</li>
<li>Install at least git 2.x &gt;=2.17
(macOS: brew install git)
(Ubuntu: sudo apt install git)
(Alpine: sudo apk add -U git)</li>
<li>Install tree &gt;=1.8.0
(macOS: brew install tree)
(Ubuntu: sudo apt install tree)
(Alpine: sudo apk add -U tree)</li>
<li>Install vim
(macOS: brew install vim)
(Ubuntu: sudo apt install vim)
(Alpine: sudo apk add -U vim)</li>
<li>Install wget
(macOS: brew install wget)
(Ubuntu: sudo apt install wget)
(Alpine: sudo apk add -U wget)</li>
<li>Install vscode for development
(macOS: brew install vscode)</li>
<li>Add the following vscode extensions:
- Docker
- EditorConfig for VS Code
- Remote - WSL
- Remote - Containers
- Remote - SSH
- Remote - SSH:Editing</li>
</ul>
<p>This prerequisites are checked automatically with <code>mkinit.sh init</code>.
Execute it with <code>${GRAV_HOME}/bin/mkinit.sh init</code>. After that
reload your shell with <code>source ${HOME}/.bashrc</code>, now the home path
variable is <code>${GRAV_HOME}</code>.</p>
<blockquote>
<p>NOTE: If you have installed all the above mentioned packages earlier, you can update it with:</p>
<ul>
<li><strong>brew upgrade <package-name>`</strong></li>
<li><strong>getssl --upgrade</strong>.</li>
</ul>
</blockquote>
<h2 id="20-project-structure"><a href="#index">2.0 Project structure</a></h2>
<p>The project consists of different directories, each one has a specific role:</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span>
|-- [ ]  bin               |-- (Directory <span class="hljs-keyword">for</span> bash scripts)
|-- [*]  cache             |-- (Directory <span class="hljs-keyword">for</span> cache files) 
|-- [*]  cfg               |-- (Directory <span class="hljs-keyword">for</span> config files)
|-- [*]  cert              |-- (Directory <span class="hljs-keyword">for</span> certificate files)
|-- [*]  data              |-- (Directory <span class="hljs-keyword">for</span> data files)  
|-- [ ]  docker            |-- (Directory <span class="hljs-keyword">for</span> docker files)
|-- [*]  key               |-- (Directory <span class="hljs-keyword">for</span> SSH &amp; user keys)
|-- [ ]  lib               |-- (Library <span class="hljs-keyword">for</span> shell scripts)
|-- [*]  rootfs            |-- (Repository <span class="hljs-keyword">for</span> packages and files)
|-- [*]  .context
|-- [ ]  .dockerignore
|-- [ ]  .editorconfig
|-- [ ]  .gitattributes
|-- [ ]  .gitignore
|-- [ ]  Dockerfile -&gt; ./docker/Dockerfile
`-- [ ]  README.md
</div></code></pre>
<blockquote>
<p><strong>Note:</strong> The files in directories marked with <code>[*]</code> are not uploaded to Git. They must be build with the appropriate <code>&lt;PROJECT_ROOT&gt;/bin/grav-mk*</code> script.</p>
<p>To initialize the project, execute <code>./bin/grav-mkinit.sh init</code> first from the <code>${GRAV_HOME}</code> directory, then activate it with <code>source ${HOME}/.bashrc</code>. From this moment you can also use the short form without appending <code>.sh</code>, e.g. <code>grav-mkinit</code>.</p>
</blockquote>
<h3 id="21-project-features"><a href="#index">2.1 Project features</a></h3>
<p>This project includes the following features:</p>
<ul>
<li>Use docker init as signal forwarder and process reaper</li>
<li>Use docker runlets for easier dockerfile development</li>
<li>Use local context key/value files for project configuration settings <code>${GRAV_HOME}/.context.*</code></li>
<li>Use local cache directory for injecting files at buildtime <code>${GRAV_HOME}/rootfs/*</code></li>
<li>Use some sophisticated bash shell scripts for build, runtime and configuration <code>${GRAV_HOME}/bin/grav-*.sh</code></li>
<li>Use the latest docker buildx builder for external docker image storage <code>--cache-from, --cache-to</code> in a local directory <code>${GRAV_HOME}/cache/.ccache</code></li>
<li>Use the latest docker buildx builder for specific platform builds, here <code>linux/amd64</code></li>
<li>Ability to create a named user <code>grav</code> with SSH keys for vscode development over remote SSH over port 2222</li>
<li>Ability to create a user password for SSH login securely</li>
<li>Ability to create and add the SSH keys for automatic logins and cache retrieval from local or remote host securely</li>
<li>Ability to create SSL certificates from letsencrypt.org with getssl</li>
<li>Use external certificate volume for certificate persistence</li>
<li>Use external cache volume for faster C/C++ compilation <code>${GRAV_HOME}/cache/.ccache</code></li>
<li>Use external cache volume for faster PHP compilation <code>${GRAV_HOME}/cache/.phpcache</code></li>
<li>Mount a docker named volume <code>grav_data</code> to a specific host directory <code>${GRAV_HOME}/data</code></li>
<li>Create a repository <code>${GRAV_HOME}/rootfs/tmp/grav/core</code> for caching grav core packages</li>
<li>Use a bunch of local bash shared library <code>libgrav*</code> for all local bash scripts</li>
</ul>
<h3 id="22-work-in-progress"><a href="#index">2.2 Work in progress</a></h3>
<ul>
<li>(WIP) Install PHP xdebug for vscode debugging over remote xdebug port</li>
<li>(WIP) Support letsencrypt SSL keys with getssl bash script</li>
<li>(TBD) Create a multistage dockerfile with base, compile and release stage</li>
<li>(TBD) Implement multiarch images wit QEMU static support</li>
<li>(TBD) Create an alpine container for smaller footprint</li>
<li>(TBD) Use NGINX instead of Apache web server</li>
<li>(TBD) Use buildx with docker composer file</li>
<li>(TBD) Ability to install grav skeletons and plugins</li>
</ul>
<h2 id="30-installation-procedure"><a href="#index">3.0 Installation procedure</a></h2>
<ul>
<li>Install the prerequisite software (See <a href="#10-prerequisites">1.0 Prerequisites</a>)</li>
<li>Download the project with git <code>git clone https://github.com/giminni/docker-grav</code></li>
<li>Change into the current project directory with <code>cd docker-grav</code></li>
<li><code>docker-grav</code> is now your <code>&lt;PROJECT_HOME&gt;</code> directory</li>
<li>Initialize the project with <code>&lt;PROJECT_HOME&gt;/bin/grav-mkinit.sh init</code></li>
<li>Reload bash shell with <code>source ${HOME}/.bashrc</code></li>
<li>Set the current grav core production and development package version with <code>grav-core.sh set all</code>, older grav core packages version can be set manually, for example with <code>grav-core.sh set 1.6.0</code> for production package version or <code>grav-core.sh set 1.7.0-rc.19</code> for development package version.</li>
<li>Download the grav core production packages with <code>grav-core.sh get all grav</code> or the core development packages with <code>grav-core.sh get all grav-admin</code>, older grav core packages can be set manually, for example with <code>grav-core.sh get 1.6.0 grav</code> for production package version or <code>grav-core.sh get 1.7.0-rc.19 grav-admin</code> for development package version.</li>
<li>Create the encrypted password for user <code>grav</code> with <code>grav-mkpass.sh &lt;user-password&gt; grav</code>, the password must contain at least 11 characters</li>
<li>Create new or use your own SSH private and public key with <code>grav-mkssh.sh &lt;email-address&gt;</code> by answering with <code>1</code> for create new SSH key or <code>2</code> for use own SSH key. The latter case will copy the key from your <code>${HOME}/.ssh</code> directory.</li>
<li>Create the cache directory with <code>grav-mkcache.sh cache</code></li>
<li>Build the docker image with <code>grav-build.sh grav grav-admin testing</code> for the development version or <code>grav-build.sh grav</code> for the production version.</li>
<li>Create the data directory with <code>grav-mkdata.sh data</code></li>
<li>Create the certificate directory with <code>grav-mkcert.sh cert</code></li>
<li>Run the docker image with <code>grav-run.sh grav grav-admin testing</code> for the development version or <code>grav_run.sh grav</code> for the production version.</li>
<li>Enter the command line of the running grav image, with <code>grav-shell.sh grav-admin</code> for the development version or <code>grav-shell.sh grav</code> for the production version.</li>
</ul>
<h3 id="31-installation-checklist"><a href="#index">3.1 Installation checklist</a></h3>
<ul>
<li>Check if scripts are available by entering <code>grav-</code> and pressing the TAB-key.</li>
<li>Check aliases from the command line with <code>alias</code>.</li>
<li>Check libraries from the command line with <code>func</code>.</li>
<li>Check if the <code>.context</code> file is created in the project directory with <code>cat ${GRAV_HOME}/.context</code>.</li>
<li>Check if the configuration directory <code>cfg</code> is populated with <code>.config.*</code> files with <code>ls -las ${GRAV_HOME}/cfg</code>.</li>
<li>Check <code>grav_pass.key</code> file under the key directory <code>key</code> with <code>cat ${GRAV_HOME}/key/grav_pass.key</code>.</li>
<li>Check if the SSH keys exists with <code>ls -las ${GRAV_HOME}/key/grav_rsa*</code> if you are using the <code>rsa</code> algorithm. Other algorithm that can be used are <code>dsa</code> and <code>ecdsa</code>.</li>
<li>Check if the grav core file was downloaded correctly into the <code>rootfs</code> directory, with <code>ls -las ${GRAV_HOME}/rootfs/tmp/grav/core</code>.</li>
<li>Check if the cache directories exists with <code>ls -las ${GRAV_HOME}/cache</code>. A subdirectory <code>.ccache</code> and <code>.phpcache</code> must exists, otherwise the <code>grav-build.sh</code> script does not start.</li>
<li>Chek if the certificate directory exists, with <code>ls -las ${GRAV_HOME}/cert</code>.</li>
<li>Check if the docker grav image exists, with <code>sudo docker images</code>.</li>
<li>Check if the docker grav image is running, with <code>sudo docker ps -a</code>.</li>
</ul>
<h3 id="32-using-local-keyvalue-files-for-configuration"><a href="#index">3.2 Using local key/value files for configuration</a></h3>
<p>To persist some project configuration data a couple of key/value files are created in the <code>${GRAV_HOME}/cfg</code> directory. A <code>${GRAV_HOME}/.context</code> file will be generated with <code>&lt;PROJECT_HOME/bin/grav-mkinit.sh init</code> at init time holding the configuration directory where all configuration files are stored.</p>
<p>E.g. <code>.context</code> file in <code>${GRAV_HOME}/</code> directory:</p>
<pre class="hljs"><code><div>GRAV_CTX=<span class="hljs-string">"<span class="hljs-variable">${GRAV_HOME}</span>/cfg"</span>
</div></code></pre>
<p>E.g. <code>.config.bin</code> file in <code>${GRAV_HOME}/cfg</code> directory:</p>
<pre class="hljs"><code><div>GRAV_BIN=<span class="hljs-string">"<span class="hljs-variable">${GRAV_HOME}</span>/bin"</span>
</div></code></pre>
<blockquote>
<p><strong>Note:</strong> Every configuration files can be changed manually by expert user or use the handy local bash scripts that starts with <code>${GRAV_HOME}/bin/grav-mk*.sh</code> for novice user.</p>
</blockquote>
<h3 id="33-using-docker-multiarch-environment"><a href="#index">3.3 Using docker multiarch environment</a></h3>
<p>Using the extended docker build features of <code>buildx</code> this project is prepared for multiarch images. That means it uses one name for different target architectures <code>linux/amd64, linux/arm64, linux/armv7, ...</code>. Currently only the <code>linux/amd64</code> architecture is supported.</p>
<h3 id="34-using-local-docker-cache-repository"><a href="#index">3.4 Using local docker cache repository</a></h3>
<p>In addition to the build and compile cache environment, there is another local directory <code>./${GRAV_HOME}/rootfs/*</code> that holds cached artefacts. This directory can be used to store for example the grav core zip files to reduce bandwith and avoid a lengthy download time from the internet.</p>
<p>In this case store the <code>grav-admin.zip</code> file under <code>${GRAV_HOME}/rootfs/tmp</code>. If the name is correct the file will be inserted into the docker buildtime context and used instead of downloading the file from the internet.</p>
<h3 id="35-handling-user-password-and-ssh-secrets"><a href="#index">3.5 Handling user password and SSH secrets</a></h3>
<p>The extended docker build features of <code>buildx</code> allows injecting sensitive data without leaving any history trace. The user password is generated externally with openssl <code>SHA512</code> encryption by a provided bash script <code>${GRAV_HOME}/bin/mkssh.sh</code>. The encrypted password is then stored under <code>${GRAV_HOME}/key/grav_pass.key</code> and injected into the container at buildtime.</p>
<p>The same thing occures for the SSH private and public key. The key are stored under <code>${GRAV_HOME}/key/grav_rsa</code> and <code>${GRAV_HOME}/key/grav_rsa.pub</code> respectively.</p>
<blockquote>
<p><strong>Note:</strong> Ensure that the SSH keys and user match the SSH keys of an external user on the local or remote host. Otherwise the user autologin over SSH and cache synchronization over github, rsync does not work.</p>
</blockquote>
<h3 id="36-caching-docker-buildtime"><a href="#index">3.6 Caching docker buildtime</a></h3>
<p>The extended docker build features of <code>buildx</code> allows to store the docker buildtime cache into a local project directory <code>${GRAV_HOME}/cache/.dcache</code>. This can be of course changed to push/pull from a pubic/private registry if needed.</p>
<h3 id="37-running-services-as-non-root-user"><a href="#index">3.7 Running services as non-root user</a></h3>
<p>To increase the overall security the privilege for required services (SSH, Cron and Apache) are deescalated to a non root user (grav). This is realized with <code>su-exec</code> <code>dropbear</code> and <code>go-cron</code>.</p>
<h3 id="38-persisting-build-cache-using-ccache-and-rsync"><a href="#index">3.8 Persisting build cache using ccache and rsync</a></h3>
<p><code>CCache</code> and <code>rsync</code> are used to speedup the building of PHP extensions. At buildtime and before the PHP compilation is started, the external cache directory <code>${GRAV_HOME}/cache/.ccache</code> is read with <code>rsync</code> into the docker container <code>&lt;CONTAINER_ROOT&gt;/tmp/.ccache</code>. CCache will reroute the compiler call to this specific directory for faster compilation. Before all build artefacts are removed the cache directory <code>&lt;CONTAINER_ROOT&gt;/tmp/.ccache</code> is exported with <code>rsync</code> using incremental backup to preserve the compiled data for a next build  <code>${GRAV_HOME}/cache/.ccache</code>.</p>
<blockquote>
<p><strong>Note:</strong> Ensure that the SSH keys and user match the SSH keys of an external user on the local or remote host.</p>
</blockquote>
<h3 id="39-working-with-vscode-locally-or-remotely"><a href="#index">3.9 Working with vscode locally or remotely</a></h3>
<p>To avoid direct access to the docker container a SSH user is fully provided and configured. The SSH server is listening on port <code>2222</code> to avoid collision with other primary SSH server.
Point your vscode remote-SSH plugin to the localhost host or to the designated IP address and port <code>2222</code> to access the docker image for development.</p>
<h3 id="310-managing-a-container-from-the-command-line"><a href="#index">3.10 Managing a container from the command line</a></h3>
<p>There are a couple of local bash scripts to create, run and delete a container:</p>
<ul>
<li><code>grav-build.sh</code> is used for building a container</li>
<li><code>grav-core.sh</code> is used to set and get the grav core packages locally</li>
<li><code>grav-run.sh</code> is used for running a container</li>
<li><code>grav-shell.sh</code> is used for accessing the command line inside a container</li>
<li><code>grav-purge.sh</code> is used for deleting all docker cached data, container and image artefacts.</li>
</ul>
<h2 id="40-configuring-a-container-from-the-command-line"><a href="#index">4.0 Configuring a container from the command line</a></h2>
<p>The following data is needed to be able to build or run a container:</p>
<ul>
<li>Grav binary directory path <code>.config.bin</code>, e.g. <code>GRAV_BIN=${GRAV_HOME}/bin&quot;</code></li>
<li>Grav cache directory path <code>.config.cache</code>, e.g. <code>GRAV_CACHE=&quot;${GRAV_HOME}/cache&quot;</code></li>
<li>Grav certificate directory path <code>.config.cert</code>, e.g. <code>GRAV_CERT=&quot;${GRAV_HOME}/cert&quot;</code></li>
<li>Grav config directory path <code>.config.cfg</code>, e.g. <code>GRAV_CFG=${GRAV_HOME}/cfg&quot;</code></li>
<li>Grav data volume directory path <code>.config.data</code>, e.g. <code>GRAV_DATA=&quot;${GRAV_HOME}/data&quot;</code></li>
<li>Grav development core version <code>.config.dev</code>, e.g. <code>GRAV_DEV=1.7.0-rc.20</code></li>
<li>Grav docker directory path <code>.config.docker</code>, e.g. <code>GRAV_DOCK=${GRAV_HOME}/docker&quot;</code></li>
<li>Grav home directory path <code>.config.home</code>, e.g. <code>GRAV_HOME=${GRAV_HOME}&quot;</code></li>
<li>Grav key directory path <code>.config.key</code>, e.g. <code>GRAV_KEY=&quot;${GRAV_HOME}/key&quot;</code></li>
<li>Grav library directory path <code>.config.lib</code>, e.g. <code>GRAV_LIB=&quot;${GRAV_HOME}/lib&quot;</code></li>
<li>Grav password file <code>.config.pass</code>, e.g. <code>GRAV_PASS=&quot;${GRAV_HOME}/key/grav_pass.key&quot;</code></li>
<li>Grav production core version <code>.config.prod</code>, e.g. <code>GRAV_PROD=1.6.1</code></li>
<li>Grav rootfs directory path <code>.config.root</code>, e.g. <code>GRAV_ROOT=&quot;${GRAV_HOME}/rootfs&quot;</code></li>
<li>Grav SSH key directory path <code>.config.ssh</code>, e.g. <code>GRAV_SSH=${GRAV_HOME}/key/grav_rsa&quot;</code></li>
<li>Grav username <code>.config.user</code>, e.g. <code>GRAV_USER=grav</code></li>
</ul>
<p>This information is stored into local project connfig files that begins with <code>${GRAV_HOME}/cfg/.*</code>. To insert this data locally some local bash scripts are used <code>grav-mk*</code>. Every file is filled with a default value, however feel free to change it to suite your needs.</p>
<ul>
<li><code>${GRAV_HOME}/bin/grav-build.sh</code> = Build the grav docker image from the specified values</li>
<li><code>${GRAV_HOME}/bin/grav-core.sh get</code>= Download the corresponding production/development core file into <code>${GRAV_HOME}/rootfs</code> directory</li>
<li><code>${GRAV_HOME}/bin/grav-mkcache.sh</code> = Configures the local cache volume path <code>${GRAV_HOME}/cache/*</code></li>
<li><code>${GRAV_HOME}/bin/grav-mkcert.sh</code> = Configures the local certificate volume path <code>${GRAV_HOME}/cert</code></li>
<li><code>${GRAV_HOME}/bin/grav-mkdata.sh</code> = Configures the local data volume path <code>${GRAV_HOME}/data</code></li>
<li><code>${GRAV_HOME}/bin/grav-mkinit.sh</code> = Initialize project, must run first. (See <a href="#-installation-procedure">Installation procedure</a>)</li>
<li><code>${GRAV_HOME}/bin/grav-mkpass.sh</code> = Configures the named container user and password</li>
<li><code>${GRAV_HOME}/bin/grav-mkssh.sh</code> = Configures the SSH private and public files for rsync, git, ...</li>
<li><code>${GRAV_HOME}/bin/grav-purge.sh</code> = Remove all grav artefacts, build cache, container and images</li>
<li><code>${GRAV_HOME}/bin/grav-run.sh</code> = Run the grav docker container from the specified values</li>
<li><code>${GRAV_HOME}/bin/grav-core.sh set</code> = Configures the grav production/development core version string</li>
<li><code>${GRAV_HOME}/bin/grav-shell.sh</code> = Access the container locally by opening a shell</li>
</ul>
<blockquote>
<p><strong>Note:</strong> Please consult the usage information of each local bash script by executing the command without arguments.</p>
</blockquote>
<h3 id="41-downloading-files-to-be-cached-into-the-rootfs-directory"><a href="#index">4.1 Downloading files to be cached into the rootfs directory</a></h3>
<p>To be able to create the project in offline situation or minimize the download time from the internet, two tasks must be executed:</p>
<ul>
<li>Define wich grav version is needed to be installed from the grav download site using a local script <code>${GRAV_HOME}/bin/grav-core.sh set</code>.  Insert as first argument <code>prod</code> or <code>dev</code>. To download a specific version use <code>&lt;PROJECT_HOME/bin/grav-core.sh get</code>. Use the same arguments like <code>${GRAV_HOME}/bin/grav-core.sh set</code></li>
</ul>
<p>E.g. to download a specific version of grav-admin core <code>1.6.0</code> enter:</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span>/bin/grav-core.sh get 1.6.0 grav-admin
</div></code></pre>
<blockquote>
<p><strong>Note:</strong> The files are stored into the <code>${GRAV_HOME}/rootfs/tmp</code>. To reduce the container size, remove all superfluous artefacts before starting the build.</p>
</blockquote>
<h3 id="42-persisting-data-into-an-external-storage"><a href="#index">4.2 Persisting data into an external storage</a></h3>
<p>To save the Grav site data to the host file system (so that it persists even after the container has been removed), simply map the container's <code>/var/www/html</code> directory to a named Docker volume <code>data</code>. This named docker volume <code>data</code> is mapped into the project directory on the host <code>${GRAV_HOME}/data</code>.</p>
<blockquote>
<p><strong>Note:</strong> If the mapped directory or named volume is empty, it will be automatically populated with a fresh install of Grav the first time that the container starts. However, once the directory/volume has been populated, the data will persist and will not be overwritten the next time the container starts.</p>
</blockquote>
<h3 id="43-building-the-image-from-dockerfile"><a href="#index">4.3 Building the image from Dockerfile</a></h3>
<p>To build the image from the command line a local bash script <code>${GRAV_HOME}/bin/grav-build.sh</code> is used.</p>
<p>This script as a lot of presetted arguments. The first argument is mandatory if not set, the script emits a usage string.</p>
<p>Here an example, how to create a user <code>grav</code> and build the latest grav+admin development package.</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span>/bin/grav-build.sh grav grav-admin testing
</div></code></pre>
<p>Here an example how to create a user <code>grav</code> and build the latest grav+admin production package. Observe that the last two arguments are omitted while presetted.</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span>/bin/grav-build.sh grav
</div></code></pre>
<p>Here the complete usage string of <code>${GRAV_HOME}/bin/grav-build.sh</code> script:</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span> $ ./bin/grav-build.sh 
grav-build: Error: Arguments are not provided!

grav-build:  Args: grav-build.sh grav_user [grav_imgname] [grav_tagname] [grav_passfile] [grav_privfile] [grav_pubfile]
grav-build:  Note: (*) are default values, (<span class="hljs-comment">#) are recommended values</span>

grav-build: Arg1:   user-name: any|(<span class="hljs-comment">#)         - (#=grav)"</span>
grav-build: Arg2:  [img-name]: grav|grav-admin - (*=grav)<span class="hljs-string">"
grav-build: Arg3:  [tag-name]: latest|testing  - (*=latest)"</span>
grav-build: Arg4: [pass-file]: any|(*)         - (*=&lt;PROJECT_HOME&gt;/key/grav_pass.key)<span class="hljs-string">"
grav-build: Arg5: [priv-file]: any|(*)         - (*=&lt;PROJECT_HOME&gt;/key/grav_rsa)"</span>
grav-build: Arg6:  [pub-file]: any|(*)         - (*=&lt;PROJECT_HOME&gt;/key/grav_rsa.pub)<span class="hljs-string">"

grav-build: Info: grav-build.sh grav grav-admin latest /home/rpiadmin/Workspace/docker-grav/key/grav_pass.key /home/rpiadmin/Workspace/docker-grav/key/grav_rsa /home/rpiadmin/Workspace/docker-grav/key/grav_rsa.pub

grav-build: Help: grav-build.sh: Builds the docker file from some entered arguments. (See Note, Info and Args)
</span></div></code></pre>
<h2 id="50-running-the-image-from-dockerfile"><a href="#index">5.0 Running the image from Dockerfile</a></h2>
<p>To run the image from the command line a local bash script <code>${GRAV_HOME}/bin/grav-run.sh</code> is needed.
This script as a lot of presetted arguments. The first argument is mandatory if not set the script emits a usage string. The default run mode is <code>n</code>ormal if there is a need to start only a bash command line and test something inside, run with the <code>d</code>ebug flag set.</p>
<p>Here an example how to run as user <code>grav</code> and use the latest <code>grav-admin</code> development package in debug mode.</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span>/bin/grav-run.sh grav grav-admin testing d
</div></code></pre>
<p>Here an example how to run as user <code>grav</code> and use the <strong>latest</strong> <code>grav-admin</code> production package. Observe that the last two arguments are omitted while presetted with <code>n</code>ormal and <code>data</code>.</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span>/bin/grav-run.sh grav grav-admin latest
</div></code></pre>
<p>Here the complete usage string of <code>${GRAV_HOME}/bin/grav-run.sh</code> script:</p>
<pre class="hljs"><code><div><span class="hljs-variable">${GRAV_HOME}</span> $ ./bin/grav-run.sh
grav-run: Error: Arguments are not provided!

grav-run:  Args: grav-run.sh grav_user [grav_imgname=grav] [grav_imgtag=latest] [grav_voldata=data]
grav-run:  Note: (*) are default values, (<span class="hljs-comment">#) are recommended values</span>

grav-run:  Arg1:  user-name: any|(<span class="hljs-comment">#) - (#=grav)</span>
grav-run:  Arg2: [img-name]: any|(*) - (*=grav-admin)
grav-run:  Arg3: [tag-name]: any|(*) - (*=latest)
grav-run:  Arg4: [run-mode]: n|d|(*) - (*=(n)ormal|(d)ebug)
grav-run:  Arg5: [vol-data]: any|(*) - (*=data)

grav-run:  Info: grav-run.sh grav grav-admin latest n data

grav-run:  Help: grav-run.sh: Instantiate a docker container depending from some entered arguments. (See Note, Info and Args)
</div></code></pre>
<p>IF you installed the <code>grav-admin</code> package then point the browser to <code>http://localhost:9080/admin</code> and create a user account, otherwise point the browser to <code>http://localhost:9080/</code> directly.</p>
<blockquote>
<p><strong>Note:</strong> The following external &lt;-&gt; internal docker ports are exposed:</p>
<ul>
<li><code>2222 &lt;-&gt; 22</code>: for SSH external host access using the named user</li>
<li><code>9080 &lt;-&gt; 80</code>: for HTTP external host access</li>
<li><code>9443 &lt;-&gt; 443</code>: for HTTPS external host access (WIP)</li>
</ul>
</blockquote>
<p>The docker image has the following scheme:</p>
<ul>
<li><code>&lt;grav-user=grav&gt;/&lt;grav-name=&lt;grav|grav-admin&gt;:&lt;grav-tag=latest|testing&gt;</code></li>
</ul>
<p>E.g. <code>grav/grav:latest</code> for production images or <code>grav/grav-admin:testing</code> for development images.</p>
<h2 id="60-abbreviation-reference-list"><a href="#index">6.0 Abbreviation reference list</a></h2>
<ul>
<li>[EOL]: <a id="EOL" href="#EOL">End of life</a></li>
<li>[SVG]: <a id="SVG" href="#SVG"> Scalable Vector Graphics</a></li>
</ul>
<h2 id="70-image-reference-list"><a href="#index">7.0 Image reference list</a></h2>
<ul>
<li>[IMG.1]: <a id="img-grav" title="Grav CMS" alt="Grav CMS" href="./media/Grav_logo.svg">Grav CMS <a href="#SVG">[SVG]</a></a></li>
</ul>
<h2 id="80-link-reference-list"><a href="#index">8.0 Link reference list</a></h2>
<ul>
<li><a href="https://learn.getgrav.org/17">Grav v1.7 Documentation</a></li>
<li><a href="https://github.com/docker-library/official-images#multiple-architectures">Docker multiple architectures</a></li>
<li><a href="https://docs.docker.com/buildx/working-with-buildx">Working with buildx</a></li>
<li><a href="https://code.visualstudio.com/docs/getstarted/tips-and-tricks">Visual Studio Code Tips &amp; Trics</a></li>
<li><a href="https://code.visualstudio.com/shortcuts/keyboard-shortcuts-macos.pdf">Visual Studio Code macOS Shortcuts</a></li>
<li><a href="https://code.visualstudio.com/shortcuts/keyboard-shortcuts-linux.pdf">Visual Studio Code Linux Shortcuts</a></li>
<li><a href="https://code.visualstudio.com/shortcuts/keyboard-shortcuts-windows.pdf">Visual Studio Code Windows Shortcuts</a></li>
</ul>

</body>
</html>
